import { NextResponse } from 'next/server';
import { supabaseAdmin } from '../../../../lib/supabase';
import { getCurrentUser } from '../../../../lib/supabase';

// GET /api/general-orders/[id] - Get specific general order
export async function GET(request, { params }) {
    try {
        const { id } = params;

        const { data: order, error } = await supabaseAdmin
            .from('general_orders')
            .select(`
                *,
                order_items (
                    id,
                    user_id,
                    product_id,
                    quantity,
                    price_per_item,
                    total_price,
                    created_at,
                    users (
                        full_name,
                        username,
                        email
                    ),
                    products (
                        name,
                        description,
                        image_url
                    )
                )
            `)
            .eq('id', id)
            .single();

        if (error) {
            if (error.code === 'PGRST116') {
                return NextResponse.json({ error: ' 拽爪转转  爪' }, { status: 404 });
            }
            console.error('Database error:', error);
            return NextResponse.json({ error: '砖 注转  拽爪转转' }, { status: 500 });
        }

        // Calculate totals
        const items = order.order_items || [];
        const total_orders = items.length;
        const total_amount = items.reduce((sum, item) => sum + (item.total_price || 0), 0);
        const unique_participants = new Set(items.map(item => item.user_id)).size;

        return NextResponse.json({
            ...order,
            total_orders,
            total_amount,
            participant_count: unique_participants
        });
    } catch (error) {
        console.error('Error fetching general order:', error);
        return NextResponse.json({ error: '砖 注转  拽爪转转' }, { status: 500 });
    }
}

// PUT /api/general-orders/[id] - Update general order
export async function PUT(request, { params }) {
    try {
        const user = getCurrentUser();
        if (!user || user.role !== 'admin') {
            return NextResponse.json({ error: ' 专砖' }, { status: 403 });
        }

        const { id } = params;
        const body = await request.json();
        const { title, description, deadline, opening_time, status } = body;

        // First check if order exists
        const { data: existingOrder, error: fetchError } = await supabaseAdmin
            .from('general_orders')
            .select('*')
            .eq('id', id)
            .single();

        if (fetchError) {
            if (fetchError.code === 'PGRST116') {
                return NextResponse.json({ error: ' 拽爪转转  爪' }, { status: 404 });
            }
            console.error('Database error:', fetchError);
            return NextResponse.json({ error: '砖 注转  拽爪转转' }, { status: 500 });
        }

        // Validate dates if provided
        if (deadline) {
            const deadlineDate = new Date(deadline);
            if (deadlineDate <= new Date() && status !== 'closed') {
                return NextResponse.json({ error: '转专 住专  转 注转' }, { status: 400 });
            }

            if (opening_time) {
                const openingDate = new Date(opening_time);
                if (openingDate >= deadlineDate) {
                    return NextResponse.json({ error: '转专 驻转  转 驻 转专 住专' }, { status: 400 });
                }
            }
        }

        // Prepare update data
        const updateData = {};
        if (title !== undefined) updateData.title = title;
        if (description !== undefined) updateData.description = description;
        if (deadline !== undefined) updateData.deadline = deadline;
        if (opening_time !== undefined) updateData.opening_time = opening_time;
        if (status !== undefined) updateData.status = status;

        const { data: updatedOrder, error } = await supabase
            .from('general_orders')
            .update(updateData)
            .eq('id', id)
            .select()
            .single();

        if (error) {
            console.error('Database error:', error);
            return NextResponse.json({ error: '砖 注  拽爪转转' }, { status: 500 });
        }

        // Send notifications for status changes
        if (status && status !== existingOrder.status) {
            try {
                let emailType = '';
                if (status === 'open' && existingOrder.status === 'scheduled') {
                    emailType = 'general_order_opened';
                } else if (status === 'closed' && existingOrder.status === 'open') {
                    emailType = 'general_order_closed';
                }

                if (emailType) {
                    // Queue closure emails instead of calling POST endpoint
                    if (emailType === 'general_order_closed') {
                        // Queue closure notification in email_queue
                        await supabaseAdmin
                            .from('email_queue')
                            .insert([{
                                recipient_email: 'SYSTEM_ORDER_CLOSED',
                                subject: ` 拽爪转转 住专 - ${updatedOrder.title}`,
                                html_body: `GENERAL_ORDER_CLOSED:${updatedOrder.id}`,
                                email_type: 'general_order_close',
                                general_order_id: updatedOrder.id,
                                status: 'pending'
                            }]);
                        
                        // Queue summary email
                        await supabaseAdmin
                            .from('email_queue')
                            .insert([{
                                recipient_email: 'SYSTEM_GENERAL_ORDER_SUMMARY',
                                subject: `住  拽爪转转 - ${updatedOrder.title}`,
                                html_body: `GENERAL_ORDER_SUMMARY:${updatedOrder.id}:MANUAL_CLOSE`,
                                email_type: 'general_order_summary',
                                general_order_id: updatedOrder.id,
                                status: 'pending'
                            }]);
                            
                        console.log(' Queued closure emails for manually closed order');
                    } else {
                        // For other status changes, keep the existing logic
                        await fetch(`${process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000'}/api/admin/email-service`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                type: emailType,
                                orderId: updatedOrder.id,
                                orderTitle: updatedOrder.title,
                                deadline: updatedOrder.deadline
                            })
                        });
                    }
                }
            } catch (emailError) {
                console.error('Failed to send status change notification:', emailError);
                // Don't fail the update if email fails
            }
        }

        return NextResponse.json(updatedOrder);
    } catch (error) {
        console.error('Error updating general order:', error);
        return NextResponse.json({ error: '砖 注  拽爪转转' }, { status: 500 });
    }
}

// DELETE /api/general-orders/[id] - Delete general order
export async function DELETE(request, { params }) {
    try {
        const user = getCurrentUser();
        if (!user || user.role !== 'admin') {
            return NextResponse.json({ error: ' 专砖' }, { status: 403 });
        }

        const { id } = params;

        // First delete related order items
        const { error: itemsError } = await supabaseAdmin
            .from('order_items')
            .delete()
            .eq('general_order_id', id);

        if (itemsError) {
            console.error('Error deleting order items:', itemsError);
            return NextResponse.json({ error: '砖 拽转 驻专 ' }, { status: 500 });
        }

        // Then delete the general order
        const { error } = await supabase
            .from('general_orders')
            .delete()
            .eq('id', id);

        if (error) {
            console.error('Database error:', error);
            return NextResponse.json({ error: '砖 拽转  拽爪转转' }, { status: 500 });
        }

        return NextResponse.json({ message: ' 拽爪转转 拽 爪' });
    } catch (error) {
        console.error('Error deleting general order:', error);
        return NextResponse.json({ error: '砖 拽转  拽爪转转' }, { status: 500 });
    }
}