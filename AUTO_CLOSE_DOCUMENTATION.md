# מערכת סגירה אוטומטית להזמנות קבוצתיות

## סקירה כללית

מערכת הסגירה האוטומטית מאפשרת סגירה אוטומטית של הזמנות קבוצתיות שחרג תאריך הסגירה שלהן. המערכת כוללת:

1. **API Endpoint** לסגירה ידנית ובדיקת הזמנות פגות תוקף
2. **כפתור בפאנל הניהול** לטריגר סגירה ידנית
3. **סקריפטים לתזמון** לסגירה אוטומטית במרווחי זמן קבועים

## רכיבי המערכת

### 1. API Endpoint
**קובץ:** `src/app/api/admin/auto-close/route.js`

#### GET Request - בדיקה (Dry Run)
```
GET /api/admin/auto-close
```
**תשובה:**
```json
{
  "expiredOrdersCount": 2,
  "expiredOrders": [
    {
      "id": "123",
      "title": "הזמנה קבוצתית",
      "deadline": "2024-01-15T10:00:00Z",
      "status": "open",
      "created_at": "2024-01-10T09:00:00Z"
    }
  ],
  "currentTime": "2024-01-15T15:30:00Z",
  "message": "2 הזמנות ממתינות לסגירה אוטומטית"
}
```

#### POST Request - סגירה אקטיבית
```
POST /api/admin/auto-close
```
**תשובה:**
```json
{
  "message": "2 הזמנות קבוצתיות נסגרו אוטומטית",
  "closedOrders": [
    {
      "id": "123",
      "title": "הזמנה קבוצתית",
      "deadline": "2024-01-15T10:00:00Z"
    }
  ]
}
```

### 2. ממשק הניהול
**מיקום:** פאנל הניהול > הזמנות קבוצתיות

כפתור "סגירה אוטומטית" מאפשר למנהלים:
- לבדוק אילו הזמנות פגות תוקף
- לסגור ידנית הזמנות פגות תוקף
- לקבל משוב מיידי על הפעולה

### 3. לוגיקת הסגירה

כאשר הזמנה נסגרת אוטומטית:

1. **עדכון סטטוס ההזמנה** - מ-`open` ל-`closed`
2. **סגירת החנות** (אם ההזמנה הפעילה הנוכחית)
   - `is_open = false`
   - `current_general_order_id = null`
   - הודעה: "החנות סגורה - ההזמנה הקבוצתית הסתיימה"
3. **שליחת התראות דוא"ל** - הודעה על סגירת ההזמנה
4. **רישום לוגים** - תיעוד הפעולה

## תזמון אוטומטי

### סקריפט Node.js
**קובץ:** `auto_close_scheduler.js`

```bash
# הרצה ידנית
node auto_close_scheduler.js

# הגדרת Cron Job (לינוקס/מק)
# כל 15 דקות
0,15,30,45 * * * * cd /path/to/project && node auto_close_scheduler.js >> logs/auto_close.log 2>&1
```

### סקריפט Windows
**קובץ:** `auto_close_scheduler.bat`

```batch
# הרצה ידנית
auto_close_scheduler.bat

# תזמון דרך Windows Task Scheduler
# פתח Task Scheduler -> Create Basic Task -> Browse לקובץ .bat
```

#### הגדרת Task Scheduler ב-Windows:
1. פתח `Task Scheduler` (מתזמן המשימות)
2. לחץ `Create Basic Task` (צור משימה בסיסית)
3. שם: "Auto Close General Orders"
4. תדירות: "Daily" (יומי)
5. זמן: כל 15 דקות (או לפי הצורך)
6. Action: "Start a program" (הפעל תוכנית)
7. Program: נתיב מלא ל-`auto_close_scheduler.bat`

## בדיקות ותיקוף

### יצירת הזמנה לבדיקה
**קובץ:** `create_test_expired_order.sql`

```sql
-- יוצר הזמנה שפג תוקפה לבדיקה
-- הרץ בקובץ SQL או דרך phpMyAdmin/Supabase
```

### בדיקה ידנית
**קובץ:** `test_auto_close.bat`

```batch
# בדיקה מהירה של ה-API
test_auto_close.bat
```

## לוגים ומעקב

### מיקום הלוגים
```
logs/auto_close.log
```

### דוגמה ללוג
```
[2024-01-15T15:30:00.000Z] Starting auto-close check...
[2024-01-15T15:30:01.234Z] Found 2 expired orders
[2024-01-15T15:30:02.456Z] Successfully closed 2 expired orders
[2024-01-15T15:30:02.457Z]   - Closed order: הזמנה קבוצתית ינואר (ID: 123)
[2024-01-15T15:30:02.458Z]   - Closed order: הזמנה קבוצתית פברואר (ID: 124)
[2024-01-15T15:30:02.500Z] Auto-close scheduler completed
```

## אבטחה ושגיאות

### הגנות
- רק מנהלים יכולים לגשת ל-API
- וולידציה של תאריכים
- טיפול בשגיאות והודעות ברורות

### שגיאות נפוצות
1. **שגיאת חיבור למסד נתונים** - בדוק הגדרות Supabase
2. **אין הרשאות** - ודא שהמשתמש הוא מנהל
3. **שגיאת CORS** - בדוק הגדרות ה-API

## הרחבות עתידיות

### תכונות מוצעות:
1. **התראות מקדימות** - דוא"ל לפני סגירה
2. **הארכה אוטומטית** - בתנאים מסוימים
3. **סטטיסטיקות** - דוח על הזמנות שנסגרו
4. **אינטגרציה עם WhatsApp** - התראות נוספות

### הגדרות מתקדמות:
```javascript
// בעתיד - קובץ הגדרות
const AUTO_CLOSE_CONFIG = {
  checkInterval: 15, // דקות
  warningBefore: 30, // דקות לפני סגירה
  autoExtend: false, // הארכה אוטומטית
  notifyUsers: true // התראה למשתמשים
};
```

## תחזוקה

### בדיקות תקופתיות:
- ודא שהלוגים נכתבים
- בדוק שההזמנות נסגרות בזמן
- וודא שהדוא"ל נשלח

### גיבוי:
- גבה את מסד הנתונים לפני שינויים
- שמור עותק של קבצי הקונפיגורציה

---

**הערה:** מערכת זו מתואמת לאזור הזמן של ירושלים ותומכת בעברית מלאה.